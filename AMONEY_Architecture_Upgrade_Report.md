# AncestorMoney (AMONEY) 架构大升级报告

**升级日期**：2026年2月9日
**架构师**：Manus AI 代码超级工程师

---

## 1. 升级核心目标

本次架构升级旨在将 AncestorMoney 项目从早期的开发版本提升至生产级架构。核心目标包括：
*   **统一权限管理体系**：消除不同合约间权限模式的不一致。
*   **文化信仰落地**：正式集成“阴阳转换器（冥界财库）”逻辑。
*   **继承机制精细化**：支持按比例分配遗产及自动化祭祀功能。
*   **系统健壮性增强**：补全边界检查与语义化错误处理。

---

## 2. 重大变更详情

### 2.1 统一权限架构 (AccessControl)
我们将所有核心合约的权限管理统一升级为 OpenZeppelin 的 `AccessControl` 角色模式。

| 合约名称 | 原模式 | 现模式 | 核心角色 |
| :--- | :--- | :--- | :--- |
| `AncestorMoney` | AccessControl | AccessControl | `DEFAULT_ADMIN_ROLE`, `PAUSER_ROLE`, `MINTER_ROLE` |
| `EvolutionReserve` | Ownable | **AccessControl** | `DEFAULT_ADMIN_ROLE` |
| `VaultFactory` | Ownable | **AccessControl** | `DEFAULT_ADMIN_ROLE` |
| `SacredVault` | AccessControl | AccessControl | `DEFAULT_ADMIN_ROLE`, `VAULT_FACTORY_ROLE` |

**优势**：这种架构完美支持您目前的 3/5 签多签钱包，并且为未来几个月后升级到 5/9 签提供了无缝切换的基础。

### 2.2 阴阳转换器 (Yin-Yang Converter)
正式在代码层面集成了“阴阳转换器”逻辑，该地址在产品层被称为“**冥界财库**”。

*   **黑洞地址**：`0x000000000000000000000000000000000000dEaD`
*   **核心特性**：
    *   **全额到账**：向该地址转账免除 0.5% 的销毁税，确保祭祀诚意不被打折。
    *   **通缩机制**：打入该地址的代币将被永久锁定，实现通货紧缩。
    *   **文化映射**：未来可与“文化能量”系统联动，实现“献祭换福报”。

### 2.3 遗产金库 2.0 (SacredVault)
对继承逻辑进行了深度重构，使其更符合真实世界的家族传承需求。

*   **按比例继承**：支持为多个受益人设置不同的分配比例（总和需为 1000，即 100%）。
*   **自动化祭祀 (Sacrificial Share)**：用户可以设置一定比例的遗产，在继承触发时自动转入“阴阳转换器”。
*   **分配机制**：新增 `distributeInheritance` 函数，支持在解锁期过后一键执行复杂的遗产分配。

---

## 3. 验证与测试结果

我们编写并运行了全量的集成测试脚本 `test/ArchitectureUpgrade.test.js`，验证结果如下：

| 测试项 | 状态 | 详情 |
| :--- | :--- | :--- |
| **阴阳转换器验证** | **PASS** | 地址正确，免税逻辑生效，转账无损耗。 |
| **统一权限验证** | **PASS** | 所有合约均能识别并正确处理角色授权。 |
| **金库创建验证** | **PASS** | 支持带祭祀份额的 Vault 创建，参数校验严密。 |
| **编译一致性** | **PASS** | 开启 `viaIR` 优化，解决了 Stack Too Deep 问题，合约运行高效。 |

---

## 4. 运维与部署建议

### 4.1 3/5 签多签管理建议
在目前的 3/5 签模式下，请确保：
1.  将所有合约的 `DEFAULT_ADMIN_ROLE` 授予多签钱包地址。
2.  任何涉及 `setTaxExempt`、`setVaultImplementation` 或 `withdraw` 的操作，都必须由多签钱包发起。

### 4.2 阴阳转换器使用建议
建议在官方网站显眼位置标注“冥界财库”地址，并引导用户通过该地址进行数字祭祀，以加速代币的通缩进程。

---
**架构师寄语**：本次升级不仅是代码的优化，更是 AMONEY 愿景的延伸。我们已经为您构建了一个稳健、神圣且极具扩展性的数字帝国基础。

**状态**：架构大升级已完成，代码已同步至 GitHub。
